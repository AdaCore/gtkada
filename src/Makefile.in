SHELL=/bin/sh
@SET_MAKE@

.SUFFIXES:
.SUFFIXES: .c .o .ads .adb .ali

.PHONY:
.PHONY: clean-generic mostlyclean-generic \
	clean distclean mostlyclean maintainer-clean

MAKE_ADB = make
INSTALL = @INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_DATA = @INSTALL_DATA@

CC = @CC@
FPIC = -fPIC
CFLAGS = @CFLAGS@ -Wall @GTK_CFLAGS@ -I.. $(FPIC)

GNATFLAGS = -O2 -gnatn -gnatwuwewl
GNATFLAGS_DEVEL = -O2 -gnatag -gnatwuwewl -g

GNATMAKE = gnatmake
GNATMAKELDFLAGS = -largs -L. @GTK_LIBS@ -lgtkada

LIB_DIR=lib-obj

CD = cd
CP = cp -p -f
CHMOD = chmod
MKDIR = mkdir -p
RMDIR = rmdir
MV = mv
ARFLAGS = r

RANLIB = @RANLIB@

SONAME        = libgtkada.so
LIBNAME       = libgtkada.so
ARCHIVENAME   = libgtkada.a

GTKADA_CONFIG = gtkada-config
GATE_SRC      = gate.adb
GATE_EX       = gate-in.exe
GATE          = gate
DGATE         = dgate

prefix        = @prefix@
exec_prefix   = $(prefix)
bindir        = $(prefix)/bin
libdir        = $(prefix)/lib
incdir        = $(prefix)/include/gtkada
alidir        = $(incdir)

HAVE_OPENGL=@HAVE_OPENGL@

ifeq ($(HAVE_OPENGL),opengl)
OPENGL_C_OBJECTS=$(LIB_DIR)/gtkglarea.o $(LIB_DIR)/gdkgl.o
OPENGL_SOURCES=gdk-gl.adb gtk-glarea.adb
OPENGL_OBJECTS=$(OPENGL_SOURCES:%.adb=$(LIB_DIR)/%.o)
OPENGL_LIBS=@GL_LIBS@
OPENGL_FLAGS=@GL_CFLAGS@
MESA_SPECS=gl_h.ads glu_h.ads
else
OPENGL_C_OBJECTS=
OPENGL_SOURCES=
OPENGL_OBJECTS=
OPENGL_LIBS=
OPENGL_FLAGS=
MESA_SPECS=
endif

c_objects = $(LIB_DIR)/misc.o

## General and public targets

all: dirs libs gates

libs: $(LIBNAME) $(ARCHIVENAME) install_ali

gates: $(GATE_EX) $(DGATE)

## Private targets

dirs:: force
	$(MKDIR) $(LIB_DIR)
	$(CHMOD) +x $(GATE) $(GTKADA_CONFIG)


$(LIBNAME):: $(LIB_DIR)/$(MAKE_ADB).o $(c_objects) $(OPENGL_OBJECTS) $(OPENGL_C_OBJECTS)
	$(CC) -shared -fPIC -o $(LIBNAME) $(LIB_DIR)/glib*.o $(LIB_DIR)/gdk*.o $(LIB_DIR)/gtk*.o $(c_objects) @GTK_LIBS@ $(OPENGL_LIBS) -lm

$(ARCHIVENAME):: $(LIB_DIR)/$(MAKE_ADB).o $(c_objects) $(OPENGL_OBJECTS) $(OPENGL_C_OBJECTS)
	$(AR) $(ARFLAGS) $(ARCHIVENAME) $(LIB_DIR)/glib*.o $(LIB_DIR)/gdk*.o $(LIB_DIR)/gtk*.o $(c_objects)
	if [ -f /usr/bin/$(RANLIB) -o -f /bin/$(RANLIB) ]; then \
	  $(RANLIB) $(ARCHIVENAME); \
	fi

# This copies the .ali files from lib_obj/ to the current directory, and change
# the permission of the files so that dgate, gate and testgtk use the dynamic
# library. We do not do this if .devel exists, so that gnatmake will still
# rebuild the files (it does not check anything if the .ali files are read-only.
install_ali::
	test -f .devel || $(CP) $(LIB_DIR)/*.ali .
	test -f .devel || $(CHMOD) -w glib*.ali gdk*.ali gtk*.ali

$(GATE_EX):: $(GATE_SRC) $(LIB_DIR)/$(MAKE_ADB).o $(c_objects)
	@if [ -f .devel ]; then \
	  $(GNATMAKE) -aO$(LIB_DIR) $(GNATFLAGS_DEVEL) -o $(GATE_EX) $(GATE_SRC) $(GNATMAKELDFLAGS); \
	else \
	  $(GNATMAKE) $(GNATFLAGS) -o $(GATE_EX) $(GATE_SRC) $(GNATMAKELDFLAGS); \
	fi

$(DGATE):: $(DGATE).adb $(LIB_DIR)/$(MAKE_ADB).o $(c_objects)
	@if [ -f .devel ]; then \
	   $(GNATMAKE) -aO$(LIB_DIR) $(GNATFLAGS_DEVEL) $(DGATE) $(GNATMAKELDFLAGS); \
	else \
	   $(GNATMAKE) $(GNATFLAGS) $(DGATE) $(GNATMAKELDFLAGS); \
	fi

$(LIB_DIR)/$(MAKE_ADB).o::
	@if [ -f .devel ]; then \
	  $(CD) $(LIB_DIR); \
	  $(GNATMAKE) -c ../$(MAKE_ADB) $(GNATFLAGS_DEVEL) $(FPIC); \
	else \
	  $(CD) $(LIB_DIR); \
	  $(GNATMAKE) -c ../$(MAKE_ADB) $(GNATFLAGS) $(FPIC); \
	fi

$(OPENGL_OBJECTS):: force
	$(CD) $(LIB_DIR); $(GNATMAKE) $(GNATFLAGS) $(FPIC) -c -q ../$(notdir $(patsubst %.o,%.adb,$@))

install: $(ARCHIVENAME) $(LIBNAME)
	@if [ "$(prefix)" != `pwd` ]; then \
	   echo Installing GtkAda in $(prefix); \
	   $(MKDIR) $(bindir); \
	   $(MKDIR) $(libdir); \
	   $(MKDIR) $(incdir); \
	   $(MKDIR) $(alidir); \
	   $(INSTALL_DATA) $(ARCHIVENAME) $(libdir); \
	   $(INSTALL_DATA) $(LIBNAME) $(libdir); \
	   $(CP) glib*.ads glib*.adb $(MESA_SPECS) $(incdir); \
	   $(CP) gdk*.ads gdk*.adb $(incdir); \
	   $(CP) gtk*.ads gtk*.adb $(incdir); \
	   $(CP) $(LIB_DIR)/glib*.ali $(LIB_DIR)/gdk*.ali $(LIB_DIR)/gtk*.ali $(alidir); \
	   $(CHMOD) -w $(alidir)/*.ali; \
	   $(INSTALL_PROGRAM) $(GTKADA_CONFIG) $(bindir); \
           $(INSTALL_PROGRAM) $(GATE) $(bindir); \
           $(INSTALL_PROGRAM) $(GATE_EX) $(bindir); \
           $(INSTALL_PROGRAM) $(DGATE) $(bindir); \
	fi
	@echo '------------------------------------------------------------------'
	@echo '--  GtkAda has now been installed.                              --'
	@echo '--  To be able to use the library, you may need to update your  --'
	@echo '--  LD_LIBRARY_PATH or to run ldconfig. You may also need to    --'
	@echo '--  update your PATH to include gtkada-config in it.            --'
	@echo '------------------------------------------------------------------'

clean-generic:
	-${RM} *.o *.ali *~ b_*.c b~*.ad? core
	-$(RM) $(LIB_DIR)/*
	-${RM} $(ARCHIVENAME) $(LIBNAME)
	-${RM} $(GATE_EX) $(DGATE)
	-${RM} .\#*

mostlyclean-generic: clean-generic
	-${RM} Makefile
	-${RM} $(GATE)
	-${RM} $(GTKADA_CONFIG)

clean: clean-generic

distclean: mostlyclean-generic

mostlyclean: mostlyclean-generic

maintainer-clean: mostlyclean-generic

## Building the C files: they all depend on the c file in the source directory
## The dependencies on the .h files have to be given explicitly

$(c_objects): $(LIB_DIR)/%.o : %.c
	$(CD) $(LIB_DIR); $(CC) -c $(CFLAGS) $(OPENGL_FLAGS) ../$<

$(LIB_DIR)/gtkglarea.o: gtkglarea.h gtkglarea.c
	$(CD) $(LIB_DIR); $(CC) -c $(CFLAGS) $(OPENGL_FLAGS) ../gtkglarea.c
$(LIB_DIR)/gdkgl.o:     gdkgl.h gdkgl.c
	$(CD) $(LIB_DIR); $(CC) -c $(CFLAGS) $(OPENGL_FLAGS) ../gdkgl.c


force:

