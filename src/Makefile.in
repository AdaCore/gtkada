SHELL=/bin/sh
@SET_MAKE@

.SUFFIXES:
.SUFFIXES: .c .o .ads .adb .ali

.PHONY:
.PHONY: clean-generic mostlyclean-generic \
	clean distclean mostlyclean maintainer-clean

TEST_LINK = test_link
INSTALL = @INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_DATA = @INSTALL_DATA@

CC = @CC@
CFLAGS = @CFLAGS@ -Wall
ALL_CFLAGS = $(CFLAGS) @GTK_CFLAGS@ -shared -fPIC

GNATCC = gcc
GNATFLAGS = -O2 -g -gnatga
ALL_GNATFLAGS = $(GNATFLAGS) -shared -fPIC

GNATMAKE = gnatmake
GNATMAKEFLAGS = $(GNATFLAGS)
GNATMAKELDFLAGS = -largs -L. @GTK_LIBS@ -lgtkada

CP = cp -p -f
CHMOD = chmod
MKDIR = mkdir -p
RMDIR = rmdir
MV = mv
ARFLAGS = r

RANLIB = @RANLIB@

SONAME        = libgtkada.so
LIBNAME       = libgtkada.so
ARCHIVENAME   = libgtkada.a

GTKADA_CONFIG = gtkada-config
GATE_SRC      = gate.adb
GATE_EX       = gate.ex
GATE          = gate
DGATE         = dgate

prefix        = @prefix@
exec_prefix   = $(prefix)
bindir        = $(prefix)/bin
libdir        = $(prefix)/lib
incdir        = $(prefix)/include/gtkada
alidir        = $(incdir)


c_objects = misc.o misc-gnat.o

all: libs gates $(GATE_EX) $(DGATE) testgtk 

libs: $(LIBNAME) $(ARCHIVENAME)

gates: modes $(GATE_EX) $(DGATE) unmodes

modes:
	$(CHMOD) -w glib*.ali gdk*.ali gtk*.ali
	$(MKDIR) gate-tmp
	$(MV) glib*.o gdk*.o gtk*.o gate-tmp

unmodes:
	$(MV) gate-tmp/* .
	$(RMDIR) gate-tmp
	$(CHMOD) +w glib*.ali gdk*.ali gtk*.ali

$(LIBNAME):: $(TEST_LINK).o $(c_objects)
	$(CC) -shared -o $(LIBNAME) glib*.o gdk*.o gtk*.o $(c_objects) @GTK_LIBS@ -lm

$(ARCHIVENAME):: $(TEST_LINK).o $(c_objects)
	$(AR) $(ARFLAGS) $(ARCHIVENAME) glib*.o gdk*.o gtk*.o $(c_objects)
	if [ -f /usr/bin/$(RANLIB) -o -f /bin/$(RANLIB) ]; then \
	  $(RANLIB) $(ARCHIVENAME); \
	fi

$(GATE_EX):: $(GATE_SRC) $(TEST_LINK).o $(c_objects)
	$(GNATMAKE) $(GNATMAKEFLAGS) -o $(GATE_EX) $(ALL_CFLAGS) $(GATE_SRC) $(GNATMAKELDFLAGS)

$(DGATE):: $(DGATE).adb $(TEST_LINK).o $(c_objects)
	$(GNATMAKE) $(GNATMAKEFLAGS) $(ALL_CFLAGS) $(DGATE) $(GNATMAKELDFLAGS)

testgtk::
	$(MAKE) -C testgtk

$(TEST_LINK).o::
	test -f $(TEST_LINK).adb || perl ./create_test_link.pl > $(TEST_LINK).adb
	$(GNATMAKE) -c $(TEST_LINK) -shared -fPIC $(GNATFLAGS)

install: $(ARCHIVENAME) $(LIBNAME)
	@if [ "$(prefix)" != `pwd` ]; then \
	   echo Installing GtkAda in $(prefix); \
	   $(MKDIR) $(bindir); \
	   $(MKDIR) $(libdir); \
	   $(MKDIR) $(incdir); \
	   $(MKDIR) $(alidir); \
	   $(INSTALL_DATA) $(ARCHIVENAME) $(libdir); \
	   $(INSTALL_DATA) $(LIBNAME) $(libdir); \
	   $(CP) glib*.ads glib*.adb $(incdir); \
	   $(CP) gdk*.ads gdk*.adb $(incdir); \
	   $(CP) gtk*.ads gtk*.adb $(incdir); \
	   $(CP) glib*.ali gdk*.ali gtk*.ali $(alidir); \
	   $(CHMOD) -w $(alidir)/*.ali; \
	   $(INSTALL_PROGRAM) $(GTKADA_CONFIG) $(bindir); \
           $(INSTALL_PROGRAM) $(GATE) $(bindir); \
           $(INSTALL_PROGRAM) $(GATE_EX) $(bindir); \
           $(INSTALL_PROGRAM) $(DGATE) $(bindir); \
	fi
	@echo ------------------------------------------------------------------
	@echo --  GtkAda has now been installed.                              --
	@echo --  To be able to use the library, you may need to update your  --
	@echo --  LD_LIBRARY_PATH or to run ldconfig. You may also need to    --
	@echo --  update your PATH to include gtkada-config in it.	      --
	@echo ------------------------------------------------------------------

clean-generic:
	-${RM} *.o *.ali *~ b_*.c core
	-${RM} $(ARCHIVENAME) $(LIBNAME)
	-${RM} $(GATE_EX) $(DGATE)
	-${RM} $(TEST_LINK) $(TEST_LINK).adb
	-${RM} .\#*

mostlyclean-generic: clean-generic
	-${RM} Makefile
	-${RM} create_test_link.pl
	-${RM} $(GTKADA_CONFIG)

clean: clean-generic
	-cd testgtk && ${MAKE} clean

distclean: mostlyclean-generic
	-${RM} config.cache config.log config.status
	-cd testgtk && ${MAKE} distclean

mostlyclean: mostlyclean-generic
	-cd testgtk && ${MAKE} mostlyclean

maintainer-clean: mostlyclean-generic
	-${RM} config.cache config.log config.status
	-${RM} configure
	-cd testgtk && ${MAKE} maintainer-clean

.c.o:
	$(CC) -c $(ALL_CFLAGS) $<
.ads.o:
	$(CC) -c $(ALL_GNATFLAGS) $<

.adb.o:
	$(CC) -c $(ALL_GNATFLAGS) $<
