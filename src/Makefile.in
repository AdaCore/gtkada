SHELL=/bin/sh
@SET_MAKE@

.SUFFIXES:
.SUFFIXES: .c .o .ads .adb .ali

.PHONY:
.PHONY: clean-generic mostlyclean-generic \
	clean distclean mostlyclean maintainer-clean

MAKE_ADB = make
INSTALL = @INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_DATA = @INSTALL_DATA@

CC = @CC@
CFLAGS = @CFLAGS@ -Wall
ALL_CFLAGS = $(CFLAGS) @GTK_CFLAGS@ -fPIC

GNATCC = gcc
GNATFLAGS = -O2 -gnatgn
GNATFLAGS_DEVEL = -O2 -gnatga -g
ALL_GNATFLAGS = $(GNATFLAGS) -fPIC

GNATMAKE = gnatmake
GNATMAKEFLAGS = $(GNATFLAGS)
GNATMAKEFLAGS_DEVEL = $(GNATFLAGS_DEVEL)
GNATMAKELDFLAGS = -largs -L. @GTK_LIBS@ -lgtkada

LIB_DIR=lib-obj

CD = cd
CP = cp -p -f
CHMOD = chmod
MKDIR = mkdir -p
RMDIR = rmdir
MV = mv
ARFLAGS = r

RANLIB = @RANLIB@

SONAME        = libgtkada.so
LIBNAME       = libgtkada.so
ARCHIVENAME   = libgtkada.a

GTKADA_CONFIG = gtkada-config
GATE_SRC      = gate.adb
GATE_EX       = gate.ex
GATE          = gate
DGATE         = dgate

prefix        = @prefix@
exec_prefix   = $(prefix)
bindir        = $(prefix)/bin
libdir        = $(prefix)/lib
incdir        = $(prefix)/include/gtkada
alidir        = $(incdir)


c_objects = $(LIB_DIR)/misc.o

## General and public targets

all: dirs libs gates

libs: $(LIBNAME) $(ARCHIVENAME) install_ali

gates: $(GATE_EX) $(DGATE)

## Private targets

dirs:: force
	$(MKDIR) $(LIB_DIR)
	$(CHMOD) +x $(GATE) $(GTKADA_CONFIG)


$(LIBNAME):: $(LIB_DIR)/$(MAKE_ADB).o $(c_objects)
	$(CC) -shared -o $(LIBNAME) $(LIB_DIR)/glib*.o $(LIB_DIR)/gdk*.o $(LIB_DIR)/gtk*.o $(c_objects) @GTK_LIBS@ -lm

$(ARCHIVENAME):: $(LIB_DIR)/$(MAKE_ADB).o $(c_objects)
	$(AR) $(ARFLAGS) $(ARCHIVENAME) $(LIB_DIR)/glib*.o $(LIB_DIR)/gdk*.o $(LIB_DIR)/gtk*.o $(c_objects)
	if [ -f /usr/bin/$(RANLIB) -o -f /bin/$(RANLIB) ]; then \
	  $(RANLIB) $(ARCHIVENAME); \
	fi

# This copies the .ali files from lib_obj/ to the current directory, and change
# the permission of the files so that dgate, gate and testgtk use the dynamic
# library. We do not do this if .devel exists, so that gnatmake will still
# rebuild the files (it does not check anything if the .ali files are read-only.
install_ali::
	test -f .devel || $(CP) $(LIB_DIR)/*.ali .
	test -f .devel || $(CHMOD) -w glib*.ali gdk*.ali gtk*.ali

$(GATE_EX):: $(GATE_SRC) $(LIB_DIR)/$(MAKE_ADB).o $(c_objects)
	if [ -f .devel ]; then \
	  $(GNATMAKE) -aO$(LIB_DIR) $(GNATMAKEFLAGS_DEVEL) -o $(GATE_EX) $(ALL_CFLAGS) $(GATE_SRC) $(GNATMAKELDFLAGS); \
	else \
	  $(GNATMAKE) $(GNATMAKEFLAGS) -o $(GATE_EX) $(ALL_CFLAGS) $(GATE_SRC) $(GNATMAKELDFLAGS); \
	fi

$(DGATE):: $(DGATE).adb $(LIB_DIR)/$(MAKE_ADB).o $(c_objects)
	if [ -f .devel ]; then \
	   $(GNATMAKE) -aO$(LIB_DIR) $(GNATMAKEFLAGS_DEVEL) $(ALL_CFLAGS) $(DGATE) $(GNATMAKELDFLAGS); \
	else \
	   $(GNATMAKE) $(GNATMAKEFLAGS) $(ALL_CFLAGS) $(DGATE) $(GNATMAKELDFLAGS); \
	fi

$(LIB_DIR)/$(MAKE_ADB).o::
	@if [ -f .devel ]; then \
	  $(CD) $(LIB_DIR); \
	  $(GNATMAKE) -c -I.. ../$(MAKE_ADB) -fPIC $(GNATFLAGS_DEVEL); \
	else \
	  $(CD) $(LIB_DIR); \
	  $(GNATMAKE) -c -I.. ../$(MAKE_ADB) -fPIC $(GNATFLAGS); \
	fi

install: $(ARCHIVENAME) $(LIBNAME)
	@if [ "$(prefix)" != `pwd` ]; then \
	   echo Installing GtkAda in $(prefix); \
	   $(MKDIR) $(bindir); \
	   $(MKDIR) $(libdir); \
	   $(MKDIR) $(incdir); \
	   $(MKDIR) $(alidir); \
	   $(INSTALL_DATA) $(ARCHIVENAME) $(libdir); \
	   $(INSTALL_DATA) $(LIBNAME) $(libdir); \
	   $(CP) glib*.ads glib*.adb $(incdir); \
	   $(CP) gdk*.ads gdk*.adb $(incdir); \
	   $(CP) gtk*.ads gtk*.adb $(incdir); \
	   $(CP) $(LIB_DIR)/glib*.ali $(LIB_DIR)/gdk*.ali $(LIB_DIR)/gtk*.ali $(alidir); \
	   $(CHMOD) -w $(alidir)/*.ali; \
	   $(INSTALL_PROGRAM) $(GTKADA_CONFIG) $(bindir); \
           $(INSTALL_PROGRAM) $(GATE) $(bindir); \
           $(INSTALL_PROGRAM) $(GATE_EX) $(bindir); \
           $(INSTALL_PROGRAM) $(DGATE) $(bindir); \
	fi
	@echo '------------------------------------------------------------------'
	@echo '--  GtkAda has now been installed.                              --'
	@echo '--  To be able to use the library, you may need to update your  --'
	@echo '--  LD_LIBRARY_PATH or to run ldconfig. You may also need to    --'
	@echo '--  update your PATH to include gtkada-config in it.            --'
	@echo '------------------------------------------------------------------'

clean-generic:
	-${RM} *.o *.ali *~ b_*.c b~*.ad? core
	-$(RM) $(LIB_DIR)/*
	-${RM} $(ARCHIVENAME) $(LIBNAME)
	-${RM} $(GATE_EX) $(DGATE)
	-${RM} .\#*

mostlyclean-generic: clean-generic
	-${RM} Makefile
	-${RM} $(GATE)
	-${RM} create_test_link.pl
	-${RM} $(GTKADA_CONFIG)

clean: clean-generic

distclean: mostlyclean-generic

mostlyclean: mostlyclean-generic

maintainer-clean: mostlyclean-generic

$(LIB_DIR)/misc.o: misc.c
	$(CD) $(LIB_DIR); $(CC) -c $(ALL_CFLAGS) ../misc.c

force:

