#!/bin/sh

current_dir="`/bin/pwd`"

begin_message() {
   clear
   cat <<EOF

  This script is provided to simplify the installation of GtkAda.

  You will be asked for confirmation before the actual installation is
  done. You can break out of this script at any time before this.

  Hit RETURN to continue.
EOF

   read x
}

# Checks for the presence of a Gtk+ binary package in gtk-bin/
check_gtk_bin() {
   gtk_bin_dir="`pwd`/gtk-bin"
   if test ! -d "$gtk_bin_dir"; then
      echo "Gtk+ binary package not found. Aborting the installation process."
      exit
   fi
}

# Find all conflicting libraries between gtk-bin and target directory
# Outputs a list of conflicting library filenames
find_conflicting_libs() {
   local target_dir=$1

   # Check lib and lib64 directories for conflicts
   for gtk_lib_dir in lib lib64; do
      if [ -d "$gtk_bin_dir/$gtk_lib_dir" ]; then
         # Check all files in gtk-bin lib directory
         for file in "$gtk_bin_dir/$gtk_lib_dir"/*; do
            if [ -e "$file" ]; then
               filename=$(basename "$file")
               # Check if file exists in target lib or lib64
               if [ -e "$target_dir/lib/$filename" ] || [ -e "$target_dir/lib64/$filename" ]; then
                  echo "$filename"
               fi
            fi
         done
      fi
   done
}

# Ask user about conflicting libraries
ask_about_conflicts() {
   local conflicts_list=$1

   echo ""
   echo "  The following libraries present in the installation package already"
   echo "  exist in the target directory:"
   echo ""
   echo "$conflicts_list" | while read lib; do
      echo "    - $lib"
   done
   echo ""
   printf "  Do you want to overwrite these libraries [y/N] ? "
   read x
   if [ "$x" = "y" -o "$x" = "Y" ]; then
      return 0
   else
      return 1
   fi
}

## Read the base directory (absolute path name)
## Sets the variable  $basedir
ask_basedir() {
   clear
   default_dir="`type gnatmake 2>/dev/null| cut -d' ' -f3`"
   default_dir="`dirname \"$default_dir\" 2>/dev/null`"

   if [ "$default_dir" != "" -a "$default_dir" != "." -a "$default_dir" != "/usr/bin" ]; then
      default_dir="`cd "$default_dir/.."; pwd`"
      cat <<EOF

  GNAT has been found in $default_dir.
  Do you want to install GtkAda there too? Hit RETURN if yes or enter
  the name of the directory in which GtkAda should be installed:

EOF
   else
     default_dir=/opt/gtkada
     cat <<EOF
  Enter the name of the directory in which you would like to install GtkAda

EOF
   fi

   while [ "$basedir" = "" ]; do
      printf "[$default_dir] "
      read basedir
      if echo "$basedir" | egrep "[ ]" >/dev/null; then
         echo "GtkAda cannot be installed in a path that contains spaces."
         echo "Please enter another directory."
         basedir=""
      else
         if [ "$basedir" = "" ]; then
            basedir="$default_dir"
         fi
         if echo "$basedir" | egrep "^[/~]" >/dev/null; then
            true
         else
            basedir="`pwd`"/"$basedir"
         fi
      fi
   done

   # Suppress the final / in basedir
   basedir="`echo "$basedir" | sed -e 's/\/$//'`"

   # Check that we have permission to write in $basedir
   if test -d "$basedir"; then
     if test -w "$basedir"; then
        if [ -x "$basedir/bin/gtkada" ]; then
           echo "  $basedir/bin/gtkada found."
           printf "  Do you want to overwrite existing installation [Y/n] ? "
           read x
           if [ "$x" = "n" -o "$x" = "N" ]; then
              echo "Aborting the installation process"
	      exit
           fi
        fi
     else
        echo "You do not have permission to write in $basedir"
        echo "Please check whether you should be root to install in that directory."
        echo "Aborting the installation process"
        exit
     fi
   else
     echo ""
     echo "  Directory $basedir does not exist."
     printf "  Do you want to create it [Y/n] ? "
     read x
     if [ "$x" = "n" -o "$x" = "N" ]; then
        echo "Aborting the installation process"
	exit
     fi
     mkdir -p "$basedir"
   fi

   # Check for conflicting libraries
   conflicting_libs=$(find_conflicting_libs "$basedir")
   if [ -n "$conflicting_libs" ]; then
      if ! ask_about_conflicts "$conflicting_libs"; then
         skip_overwriting_libs=1
         # Store the list of conflicting files for later use
         conflicting_files="$conflicting_libs"
      fi
   fi

   echo ""
   printf "  Are you now ready to proceed with the installation [Y/n] ? "
   read x
   if [ "$x" = "n" -o "$x" = "N" ]; then
      echo "Aborting the installation process"
      exit
   fi
}

##################################
## Do the actual installation
##################################

install_binaries() {

  echo "Copying the Gtk+ binaries"

  # Copy binaries, excluding conflicting libs if requested
  if [ "$skip_overwriting_libs" = "1" ]; then
     # Detect conflicting files if not already detected (e.g., in non-interactive mode)
     if [ -z "$conflicting_files" ]; then
        conflicting_files=$(find_conflicting_libs "$basedir")
     fi

     # Create tar with exclude patterns for each conflicting file
     # Build the exclude arguments dynamically from the detected conflicts
     ( cd "$gtk_bin_dir" && \
       tar $(echo "$conflicting_files" | sed 's/^/--exclude=*\//' | tr '\n' ' ') -cf - . ) | \
     ( cd "$basedir" && tar -xf - )
  else
     cp -r "$gtk_bin_dir"/* "$basedir"
  fi

  echo "Setting up the environment"
  eval `"$basedir"/bin/gtkada-env.sh --print-only`

  # Update gdkpixbuf loaders cache

  LD_LIBRARY_PATH=$basedir/lib:$basedir/lib64:$LD_LIBRARY_PATH \
  GDK_PIXBUF_MODULE_FILE=$basedir/lib/gdk-pixbuf-2.0/2.10.0/loaders.cache \
  GDK_PIXBUF_MODULEDIR=$basedir/lib/gdk-pixbuf-2.0/2.10.0/loaders \
  $basedir/bin/gdk-pixbuf-query-loaders --update-cache

  # Update immodules cache

  LD_LIBRARY_PATH=$basedir/lib:$basedir/lib64:$LD_LIBRARY_PATH \
  GTK_IM_MODULE_FILE=$basedir/lib/gtk-3.0/3.0.0/immodules.cache \
  GTK_PATH=$basedir/lib/gtk-3.0 \
  $basedir/bin/gtk-query-immodules-3.0 --update-cache

  echo "Compiling GtkAda"
  ./configure --prefix="$basedir" && make all install 2>&1 | \
     tee install.log

  # Test for the presence of a gtkada.gpr as check that the install succeeded
  if [ ! -f "$basedir/lib/gnat/gtkada.gpr" ]; then
     echo ""
     echo "An error occurred. Please see install.log."""
     exit 1
  fi
}

##
##  Write the end message
##
end_message() {
   clear
   cat <<EOF

   GtkAda has now been installed on your machine.

   You can enter the GtkAda environment by doing:

      "$basedir/bin/gtkada-env.sh"

EOF
}

## Main program

# Initialize variables
skip_overwriting_libs=0
interactive_mode=0

if [ $# -ge 1 ]; then
  if [ "$1" = "--help" ]; then
    printf "
   Usage: $0 [options] [install_dir]

   When no arguments are specified, runs the GtkAda installer
   interactively. Otherwise installs automatically.

   Options:
      --help              Show this help message
      --no-overwrite      Do not overwrite existing libraries in the target directory
"
  else
    # Parse arguments
    while [ $# -gt 0 ]; do
      case "$1" in
        --no-overwrite)
          skip_overwriting_libs=1
          shift
          ;;
        *)
          break
          ;;
      esac
    done

    # Remaining argument should be the install directory
    if [ $# -eq 1 ]; then
      echo "installing GtkAda under $1"
      check_gtk_bin
      basedir="$1"
      mkdir -p $basedir || exit 1
      install_binaries
      end_message
    else
      echo "Error: Invalid arguments"
      exit 1
    fi
  fi
  exit 0
fi

# Perform interactive install

check_gtk_bin
interactive_mode=1
begin_message
ask_basedir
install_binaries
end_message

